Сервис получения авто с различных площадок и постинга их в ТГ группу, а также поиск с фильтрацией в ТГ боте.

### Предварительные настройки.

### Создать базу:
1. создать базу Postgres с названием `gur_car_bot`
2. название базы содержится в разделе: `spring.datasource.url: jdbc:postgresql://localhost:5432/gur_car_bot`

### Создать бот и группу:
1. Зайдите в телеграм канал https://t.me/BotFather
2. В разделе меню выберите `/newbot`
3. Следуйте инструкциям и создайте бота и группу
4. Скопируйте token и вставьте в `application-local.yaml` в раздел: `application.telegram.bot.token = xxx`
5. Идентификато группы должен начинаться с минуса `group-id: -00000000`
6. В группе необходимо создать несколько подгрупп и указать их ИД в разделе # id подгрупп для постинга

### Тестовая загрузка:
При первой загрузке flyway загрузит в БД начальные данные, как будто парсер уже получил данные по нескольким авто, но ещё не распарсил их.\
Таблица `vehicles` будет заполнена не полностью. Первичные данные включают в себя:
`auction_id`, `vin`, `auction`, `status`, `link`, `auction_data`
`status` будет равен `AWAIT_CALC`, т.е. ожидает расчёта

### Работа ТГ группы:
Через 1 минуту стартует сервис расчёта. Он возьмёт пачку авто и попытается распарсить полученный на предыдущем этапе JSON с полными данными об авто. В случае неудачи изменит статус записи.

После успешного парсинга JSON-а в таблице `vehicles` появятся найденные в JSON данные и изменится статус на `WEB`, т.е. запись готова для использования постинге в группу и на сайте. Также заполнится таблица `pictures` ссылками на изображения авто найденные в JSON. Главная картинка каждого авто имеет тип `FIRST`, все остальные `SECOND`.

Через промежутки времени будет запускаться сервис, который выбирает из имеющихся авто актуальные для постинга в телеграм-группу и формирует таблицу для постинга с учётом, в какую группу в какую подгруппу будет производиться постинг.\
>Почему был сделан отдельный сервис? Для распараллеливания действий. Авто (в будущем) могут отправляться не только в телеграм-группу, но и на e-mail или непосредственно в личный чат пользователю (подписавшемуся на рассылку). Для чего в таблице `posts` есть поля `user_type`, `group_channel_id`.

Далее стартует "Постер". Он читает таблицу `posts`, забирает определенное количество постов для отправки в статусе `CREATED` и отправляет их по указанным адресам. В текущей реализации только телеграм-группа (подгруппы).\
Отправка производится в синхронном режиме, т.к. телеграм не разрешает множественные вызовы. При количестве вызовов больше отведённого сервису телеграм блокирует загрузку и отдаёт ошибку с указанным временем до конца блокировки. Сервис постинга учитывает это и засыпает на указанное время в избежании DDOS и последующего бана.\
После постинга записываем в таблицу `posts` идентификаторы сообщений в ТГ (обычно один пост - это несколько сообщений) для возможности в дальнейшем удалить его из ТГ. Также меняем статус записи на `POSTED`.

Также периодически стартует сервис удаления записей в канале ТГ. Он читает пачку записей из таблицы `posts`, сравнивает дату удаления и если она подошла, то удаляет запись из ТГ группы указывая в записи статус `DELETED`. Иногда ТГ не может удалить запись по каким либо внутренним причинам, в этом случае он отдаст ошибку и в таблицу запишется статус `DELETED_ERROR`. Такие записи считаются удалёнными, чтобы не пытаться удалять их заново и не забивать канал. (Особенность ТГ)

## Значения сервисов

**parser:**
- установить флаг `true`, для первичной загрузки списка найденных авто с сайта (не работает без логин/пароля):\
  `application.parser.auctionspark.seed.enabled = true`
- установить флаг `true`, для запуска скачивания деталей по каждому авто с сайта (не работает без логин/пароля):\
  `application.parser.auctionspark.details.enabled = true`
- установить флаг `true`, для парсинга каждого скачанного авто и калькуляции данных (заполнение таблицы для загрузки в бот):\
  `application.parser.auctionspark.calculation.enabled = true`

**publisher:**
- установить флаг `true`, для расчёта какие авто будут отправляться в бот (боты):\
  `application.publisher.seed.enabled: true`
- установить флаг `true`, постинга авто с набором изображений в бот:\
  `application.publisher.post.enabled: true`
- установить флаг `true`, удаления не актуальных (уже разыгранных) авто из бота:\
  `application.publisher.delete.enabled: true`

## Работа ТГ бота (основы)

В зарегистрированном боте появляется возможность искать по различным фильтрам записи из таблицы `vehicle` в статусе `WEB`.\
При отправке боту команды `/start` загружаются начальные данные (в зависимости от языка пользователя), выбор настроек, фильтров, данных о компании и т.д.\
Любой пользователь может настроить фильтр поиска, который будет сохранён для него в таблице `filters`.\
При поиске по фильтру пользователю выдаётся несколько постов с расчётом, сколько всего постов найдено и где он находится, с предложением продолжить просмотр далее. При нажатии на кнопку "продолжить просмотр", пользователю загружается очередная партия постов (пагинация).\
Также пользователь может посмотреть информацию о компании, задать вопрос, сделать заказ понравившегося авто.\
Если пользователь хочет задать вопрос, программа входит в режим слушания ТГ и ждёт, что пользователь напишет вопрос и отправит. Если этого не произошло, программа сбросит настройки, и при любом другом шаге (кроме отправки вопроса) сбросит режим вопроса. Если вопрос всё же задан, он будет сохранён в таблицу `messages`.\ \
Также туда будет сохранён заказ, если пользователь нажмёт "заказ". Пользователю покажем весёлую картинку и скажем, что заказ принят, ожидайте.

## Работа смартфон-приложения

В паре с сервисом работает приложение для Android.\
Приложение сканирует VIN-номер, делает фото авто и присылает их по REST API `/v1/file/upload`.\
Безопасность выполнена посредством передачи хедера `X-API-Key` из приложения в сервис. Полученные фото сохраняются на сервере. В локальной версии в папку `images`.\
REST API можно увидеть в Swagger по адресу http://localhost:5000/swagger-ui/index.html?configUrl=/v3/api-docs/swagger-config.\
В будущем приложение сможет отправлять на сервис данные об авто, такие как цена, пробег и т.д. по REST API `/v1/send_data`.
